#!/bin/bash
set -euo pipefail

base_syatem() {
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "╔════════════════════════════════════════════════╗"
        echo "║          Установка базовой системы             ║"
        echo "╚════════════════════════════════════════════════╝"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "╔════════════════════════════════════════════════╗"
        echo "║         Installing base system                 ║"
        echo "╚════════════════════════════════════════════════╝"
    fi
    echo ""
    basestrap /mnt terminus-font iptables-nft base base-devel mkinitcpio openrc dbus dbus-openrc elogind-openrc linux-firmware dialog acpid flatpak acpid-openrc chrony-openrc dash chrony linux-api-headers rsync lib32-udev
    fast-chroot /mnt flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
}

linux_zen_base() {
    base_syatem
    basestrap /mnt linux-zen linux-zen-headers
}
linux_lts_base() {
    base_syatem
    basestrap /mnt linux-lts linux-lts-headers
}
linux_base() {
    base_syatem
    basestrap /mnt linux linux-headers
}
ru_version() {
# Диалог выбора ядра
    base_syatem_kernel=$(dialog --title "Выберите ядро" --menu "Ядро" 12 50 5 \
        1 "linux-zen (скорость)" \
        2 "linux-lts (стабильность)" \
        3 "linux (стандарт)" \
        3>&1 1>&2 2>&3 3>&-)
}

eu_version() {
# Диалог выбора ядра
    base_syatem_kernel=$(dialog --title "Select kernel" --menu "Kernel" 12 50 5 \
        1 "linux-zen (performance optimized)" \
        2 "linux-lts (long-term support)" \
        3 "linux (standard / default)" \
        3>&1 1>&2 2>&3 3>&-)
}

if [ "${LENG_MODE:-}" = "ru" ]; then
    ru_version
elif [ "${LENG_MODE:-}" = "eu" ]; then
    eu_version
fi

case $? in
    0)
        case $base_syatem_kernel in
            1) linux_zen_base ;;
            2) linux_lts_base ;;
            3) linux_base ;;
            *)
                if [ "${LENG_MODE:-}" = "ru" ]; then
                    echo "Неверный выбор"
                elif [ "${LENG_MODE:-}" = "eu" ]; then
                    echo "Invalid choice"
                fi
                exit 1
                ;;
        esac
        ;;
    *)
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Выбор отменен"
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Selection cancelled"
        fi
        exit 1
        ;;
esac
unset base_syatem_kernel

################################################################################
# Создание файлов OS release
config_system() {
    cat > /mnt/usr/lib/os-release << 'OS_EOF'
NAME="Quasar Linux REV-1.1"
PRETTY_NAME="Quasar Linux"
ID=quasar
BUILD_ID=rolling
ANSI_COLOR="38;2;23;147;209"
HOME_URL="https://quasarfoks.github.io/QuasarLinux"
DOCUMENTATION_URL="https://github.com/b-e-n-z1342/QuasarLinux/wiki"
SUPPORT_URL="#"
BUG_REPORT_URL="https://github.com/QuasarFoks/QuasarLinux/issues"
PRIVACY_POLICY_URL="https://quasarfoks.github.io/policy"
LOGO=quasarlogo
OS_EOF

    cat > /mnt/etc/lsb-release << 'LSB_EOF'
DISTRIB_ID=Quasar
DISTRIB_RELEASE=1.1
DISTRIB_DESCRIPTION="Quasar Linux"
DISTRIB_CODENAME=rolling
LSB_EOF

    cat > /mnt/etc/rc.conf << 'EOF'
# =============================================
# OpenRC Configuration - Parallel Boot Optimized
# =============================================

# ПАРАЛЛЕЛЬНАЯ ЗАГРУЗКА
rc_parallel="YES"           # Включить параллельный запуск
rc_parallel_rcwait="NO"    # Не ждать завершения rc-сервисов


# ЛОГИРОВАНИЕ И ОТЛАДКА
rc_logger="YES"            # Логировать в /var/log/rc.log
rc_log_path="/var/log/rc.log"
rc_verbose="NO"            # Тихий режим (меньше вывода)

# СИСТЕМНЫЕ НАСТРОЙКИ
unicode="YES"              # Поддержка Unicode
rc_cgroup_mode="legacy"    # Режим cgroups

# ТАЙМАУТЫ
rc_timeout_stopsec="10"    # Таймаут остановки (секунд)
rc_timeout_startsec="30"   # Таймаут запуска

# СЕТЬ
rc_nocolor="NO"            # Цветной вывод
rc_hotplug="*"             # Обработка hotplug событий
EOF

    # 2. Дополнительные настройки для ускорения
    cat > /mnt/etc/conf.d/rc << 'EOF'
# Дополнительные настройки для ускорения загрузки
RC_PARALLEL_STARTUP="yes"        # Параллельный запуск
RC_PARALLEL_STARTUP_NICE="10"    # Приоритет для параллельных задач
RC_RETRY_KILL="3"               # Попыток убить процесс
RC_RETRY_TIMEOUT="5"            # Пауза между попытками
EOF
}

config_system
###############################################################################
# Принудительная настройка issue
echo "Quasar Linux \\r \\l" > /mnt/etc/issue
echo "Quasar Linux" > /mnt/etc/issue.net
echo "Welcome to Quasar Linux!" > /mnt/etc/motd
cd /mnt/bin
ln -sf dash sh
cd

sleep 5
clear

cat > /mnt/etc/locale.gen << 'EOF'
# Auto-generated locales
en_US.UTF-8 UTF-8
ru_RU.UTF-8 UTF-8
EOF
fast-chroot /mnt locale-gen

if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "LANG=ru_RU.UTF-8" > /mnt/etc/locale.conf
    echo "LC_COLLATE=C" >> /mnt/etc/locale.conf
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "LANG=en_US.UTF-8" > /mnt/etc/locale.conf
    echo "LC_COLLATE=C" >> /mnt/etc/locale.conf
fi

if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "Активация сервисов"
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "Activating services"
fi

mount --types proc /proc /mnt/proc
mount --rbind /sys /mnt/sys
mount --rbind /dev /mnt/dev
mount --rbind /run /mnt/run
rm /mnt/etc/fstab
fstabgen -U /mnt >> /mnt/etc/fstab

# Активация сервисов
#   {service}       {runlevel}
#
#   1) UDEV         sysvinit
#   2) DBUS         boot
#   3) ELOGIND      boot
#   4) ACPID        default
#
######################################################################################
#  udev
if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "╔════════════════════════════════════════════════╗"
    echo "║              Настройка сервисов                ║"
    echo "╚════════════════════════════════════════════════╝"
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "╔════════════════════════════════════════════════╗"
    echo "║            Configuring services                ║"
    echo "╚════════════════════════════════════════════════╝"
fi
echo ""

if fast-chroot /mnt rc-update add udev sysinit; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "udev успешно добавлен в автозагрузку"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "udev successfully added to autostart"
    fi
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Ошибка, устанавливаем udev..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Error, installing udev..."
    fi
    fast-chroot /mnt pacman -S udev lib32-udev || fast-chroot /mnt pacman -S udev
    fast-chroot /mnt rc-update add udev sysinit
fi

######################################################################################
# dbus

if fast-chroot /mnt rc-update add dbus boot; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "dbus успешно добавлен в автозагрузку"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "dbus successfully added to autostart"
    fi
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Ошибка, устанавливаем dbus..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Error, installing dbus..."
    fi
    fast-chroot /mnt pacman -S dbus dbus-openrc
    fast-chroot /mnt rc-update add dbus boot
fi

######################################################################################
# elogind

if fast-chroot /mnt rc-update add elogind boot; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "elogind успешно добавлен в автозагрузку"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "elogind successfully added to autostart"
    fi
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Ошибка, устанавливаем elogind..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Error, installing elogind..."
    fi
    fast-chroot /mnt pacman -S elogind elogind-openrc
    fast-chroot /mnt rc-update add elogind boot
fi

########################################################################################
# acpid

if fast-chroot /mnt rc-update add acpid default; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "acpid успешно добавлен в автозагрузку"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "acpid successfully added to autostart"
    fi
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Ошибка, устанавливаем acpid..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Error, installing acpid..."
    fi
    fast-chroot /mnt pacman -S acpid acpid-openrc
    fast-chroot /mnt rc-update add acpid default
fi

#########################################################################################
# Копирование конфигурационных файлов

if [ -f /installer/configs/pacman.conf ]; then
    rm /mnt/etc/pacman.conf
    cp /installer/configs/pacman.conf /mnt/etc/
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Предупреждение: pacman.conf не найден"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Warning: pacman.conf not found"
    fi
fi

if [ -f /installer/configs/pacman.d/mirrorlist ]; then
    rm /mnt/etc/pacman.d/mirrorlist
    cp /installer/configs/pacman.d/mirrorlist /mnt/etc/pacman.d/
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Предупреждение: pacman.d не найден"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Warning: pacman.d not found"
    fi
fi

#########################################################################################
# Копирование post-инсталляционных скриптов

cp -r /installer/modules/post /mnt/
cp -r /installer/regions /mnt/

#########################################################################################

# Убираем автогенерацию motd
if [ -d /mnt/etc/update-motd.d/ ]; then
    rm -rf /mnt/etc/update-motd.d/
fi

########################################################################################
# Симлинк для совместимости
ln -sf /usr/lib/os-release /mnt/etc/os-release 2>/dev/null || true

##########################################################################################

if [ -d /installer/configs/pixmaps ]; then
    rm -rf /mnt/usr/share/pixmaps
    cp -r /installer/configs/pixmaps /mnt/usr/share
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Предупреждение: pixmaps не найден"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Warning: pixmaps not found"
    fi
fi

###########################################################################################
# Распаковка recovery образа
if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "Установка recovery системы..."
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "Installing recovery system..."
fi

# Проверяем существование recovery раздела
if mountpoint -q /mnt/recovery; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Recovery раздел смонтирован, продолжаем..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Recovery partition is mounted, continuing..."
    fi

    # Проверяем существование recovery архива
    if [ -f "/installer/image/recovery.tar.xz" ]; then
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Найден recovery.tar.xz, распаковываю в /mnt/recovery..."
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Found recovery.tar.xz, extracting to /mnt/recovery..."
        fi

        # Распаковываем с сохранением прав и перезаписью существующих файлов
        tar -xJf "/installer/image/recovery.tar.xz" -C /mnt/recovery --strip-components=1 --keep-newer-files

        if [ $? -eq 0 ]; then
            if [ "${LENG_MODE:-}" = "ru" ]; then
                echo "Recovery система успешно установлена!"
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                echo "Recovery system installed successfully!"
            fi

            # Добавляем запись в fstab для автоматического монтирования recovery
            if ! grep -q "/recovery" /mnt/etc/fstab; then
                RECOVERY_UUID=$(blkid -s UUID -o value "$(mount | grep '/mnt/recovery' | cut -d' ' -f1)")
                if [ -n "$RECOVERY_UUID" ]; then
                    echo "# Recovery partition" >> /mnt/etc/fstab
                    echo "UUID=$RECOVERY_UUID /recovery ext2 defaults,noatime 0 2" >> /mnt/etc/fstab
                    if [ "${LENG_MODE:-}" = "ru" ]; then
                        echo "Запись для recovery добавлена в fstab"
                    elif [ "${LENG_MODE:-}" = "eu" ]; then
                        echo "Recovery entry added to fstab"
                    fi
                fi
            fi
        else
            if [ "${LENG_MODE:-}" = "ru" ]; then
                echo "Ошибка при распаковке recovery системы!"
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                echo "Error unpacking recovery system!"
            fi
            exit 1
        fi
    else
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Предупреждение: recovery.tar.xz не найден по пути /installer/image/recovery.tar.xz"
            echo ""
            echo "Проверяем альтернативные пути..."
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Warning: recovery.tar.xz not found at /installer/image/recovery.tar.xz"
            echo ""
            echo "Checking alternative paths..."
        fi

        # Поиск recovery архива в других возможных местах
        if [ -f "/installer/recovery.tar.xz" ]; then
            if [ "${LENG_MODE:-}" = "ru" ]; then
                echo "Найден /installer/recovery.tar.xz, распаковываю..."
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                echo "Found /installer/recovery.tar.xz, extracting..."
            fi
            tar -xJf "/installer/recovery.tar.xz" -C /mnt/recovery --strip-components=1 --keep-newer-files

        elif [ -f "/recovery.tar.xz" ]; then
            if [ "${LENG_MODE:-}" = "ru" ]; then
                echo "Найден /recovery.tar.xz, распаковываю..."
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                echo "Found /recovery.tar.xz, extracting..."
            fi
            tar -xJf "/recovery.tar.xz" -C /mnt/recovery --strip-components=1 --keep-newer-files

        else
            if [ "${LENG_MODE:-}" = "ru" ]; then
                echo "Recovery архив не найден. Пропускаем установку recovery системы."
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                echo "Recovery archive not found. Skipping recovery system installation."
            fi
        fi
    fi
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Предупреждение: Recovery раздел не смонтирован. Пропускаем установку recovery."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Warning: Recovery partition is not mounted. Recovery installation skipped."
    fi
fi

###################################
#                                 #
#       Пост установка            #
#                                 #
###################################
cat >> /mnt/usr/local/bin/post_install << 'EOF'
#!/bin/bash
setfont cyr-sun16
cd /post
sudo ./post_install
EOF

clear
if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "Установка бренда"
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "Installing branding"
fi

chmod +x /mnt/usr/local/bin/post_install
wget -O QuasarLinux.tar.bz2 "https://github.com/QuasarFoks/QuasarLinux/releases/download/REV-1.1-image/system-rev-1-1.tar.bz2" || {
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Не скачалось"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Download failed"
    fi
    exit 1
}

downloaded_hash=$(sha256sum QuasarLinux.tar.bz2 | cut -d' ' -f1)
expected_hash="ad19f72b38d020e72bf47756e85787687cd35bf711836e973e848dff8c8a5c78"

if [ "$downloaded_hash" = "$expected_hash" ]; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Хеш совпал, распаковываю..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Hash matches, extracting..."
    fi
    tar -xf QuasarLinux.tar.bz2 -C /mnt/
    rm -f /mnt/README 2>/dev/null
else
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Хеш не совпал!"
        echo "Ожидалось: $expected_hash"
        echo "Получено:  $downloaded_hash"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Hash mismatch!"
        echo "Expected: $expected_hash"
        echo "Got:      $downloaded_hash"
    fi
    exit 1
fi

if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "Базовая установка завершена!"
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "Base installation completed!"
fi

unset expected_hash
unset downloaded_hash
