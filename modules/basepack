#!/bin/bash
set -euo pipefail

linux_zen_base() {
    clear
    basestrap /mnt terminus-font iptables-nft linux-zen base base-devel mkinitcpio openrc dbus dbus-openrc elogind-openrc linux-firmware linux-zen-headers dialog acpid linux-api-headers flatpak acpid-openrc
    fast-chroot /mnt flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
}

linux_lts_base() {
    clear
    basestrap /mnt terminus-font iptables-nft linux-lts base base-devel mkinitcpio openrc dbus dbus-openrc elogind-openrc linux-firmware linux-lts-headers dialog acpid linux-api-headers flatpak acpid-openrc
    fast-chroot /mnt flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
}

linux_base() {
    clear
    basestrap /mnt terminus-font iptables-nft linux base base-devel mkinitcpio openrc dbus dbus-openrc elogind-openrc linux-firmware linux-headers dialog acpid linux-api-headers flatpak acpid-openrc
    fast-chroot /mnt flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
}

# Диалог выбора ядра
boxbase=$(dialog --title "Выберите ядро" --menu "Пакеты" 12 50 5 \
    1 "linux-zen (скорость)" \
    2 "linux-lts (стабильность)" \
    3 "linux (стандарт)" \
    3>&1 1>&2 2>&3 3>&-)

case $? in
    0)
        case $boxbase in
            1) linux_zen_base ;;
            2) linux_lts_base ;;
            3) linux_base ;;
            *) echo "Неверный выбор"; exit 1 ;;
        esac
        ;;
    *)
        echo "Выбор отменен"
        exit 1
        ;;
esac
################################################################################
# Создание файлов OS release
cat > /mnt/usr/lib/os-release << 'OS_EOF'
NAME="Quasar Linux"
PRETTY_NAME="Quasar Linux (Artix base)"
ID=quasar
ID_LIKE=artix
ANACONDA_ID="quasar"
VERSION="REV-1-Debug"
VERSION_ID="1.0"
BUILD_ID="rolling"
ANSI_COLOR="0;36"
HOME_URL="https://b-e-n-z1342.github.io"
LOGO=quasarlogo
OS_EOF

cat > /mnt/etc/lsb-release << 'LSB_EOF'
DISTRIB_ID=Quasar
DISTRIB_RELEASE=1.0
DISTRIB_DESCRIPTION="Quasar Linux"
DISTRIB_CODENAME=rolling
LSB_EOF
###############################################################################
# Принудительная настройка issue
echo "Quasar Linux \\r \\l" > /mnt/etc/issue
echo "Quasar Linux" > /mnt/etc/issue.net
echo "Welcome to Quasar Linux!" > /mnt/etc/motd

sleep 5
clear
echo "Активация сервисов"
mount --types proc /proc /mnt/proc
mount --rbind /sys /mnt/sys
mount --rbind /dev /mnt/dev
mount --rbind /run /mnt/run

fstabgen -U /mnt >> /mnt/etc/fstab
# Активация сервисов
######################################################################################
# dbus

if fast-chroot /mnt rc-update add dbus default; then
    echo "dbus успешно добавлен в автозагрузку"
else
    echo "Ошибка, устанавливаем dbus..."
    fast-chroot /mnt pacman -S dbus dbus-openrc
    fast-chroot /mnt rc-update add dbus default
fi

######################################################################################
#  udev

if fast-chroot /mnt rc-update add udev default; then
    echo "udev успешно добавлен в автозагрузку"
else
    echo "Ошибка, устанавливаем udev..."
    fast-chroot /mnt pacman -S udev lib32-udev || fast-chroot /mnt pacman -S udev
    fast-chroot /mnt rc-update add udev default
fi

######################################################################################
# elogind

if fast-chroot /mnt rc-update add elogind default; then
    echo "elogind успешно добавлен в автозагрузку"
else
    echo "Ошибка, устанавливаем elogind..."
    fast-chroot /mnt pacman -S elogind elogind-openrc
    fast-chroot /mnt rc-update add elogind default
fi

########################################################################################
# acpid

if fast-chroot /mnt rc-update add acpid default; then
    echo "acpid успешно добавлен в автозагрузку"
else
    echo "Ошибка, устанавливаем acpid..."
    fast-chroot /mnt pacman -S acpid acpid-openrc
    fast-chroot /mnt rc-update add acpid default
fi

#########################################################################################
# Копирование конфигурационных файлов

if [ -f /installer/configs/pacman.conf ]; then
    rm /mnt/etc/pacman.conf
    cp /installer/configs/pacman.conf /mnt/etc/
else
    echo "Предупреждение: pacman.conf не найден"
fi
if [ -f /installer/configs/pacman.d/mirrorlist ]; then
    rm /mnt/etc/pacman.d/mirrorlist
    cp /installer/configs/pacman.d/mirrorlist /mnt/etc/pacman.d/
else
    echo "Предупреждение: pacman.d не найден"
fi
#########################################################################################
# Копирование post-инсталляционных скриптов

cp -r /installer/modules/post /mnt/
cp -r /installer/regions /mnt/

#########################################################################################

# Убираем автогенерацию motd
if [ -d /mnt/etc/update-motd.d/ ]; then
    rm -rf /mnt/etc/update-motd.d/
fi

########################################################################################
# Симлинк для совместимости
ln -sf /usr/lib/os-release /mnt/etc/os-release 2>/dev/null || true

##########################################################################################

# Защита системных файлов (только если они существуют)

###########################################################################################
###################################
#                                 #
#       Пост установка            #
#                                 #
###################################
cat >> /mnt/usr/local/bin/post_install << EOF
#!/bin/bash
setfont ter-v16n
cd /post
sudo ./post_install
EOF
chmod +x /mnt/usr/local/bin/post_install

#
echo "Базовая установка завершена!"
