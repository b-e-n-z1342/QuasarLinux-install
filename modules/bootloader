#!/bin/bash 
set -euo pipefail

UEFI_MODE=0
[ -d /sys/firmware/efi ] && UEFI_MODE=1

root_dev=$(findmnt -n -o SOURCE /mnt)
ROOT_UUID=$(blkid -s UUID -o value "$root_dev")
export ROOT_UUID

mnt_dev=$(findmnt -n -o SOURCE /mnt)
disk_dev=$(lsblk -no PKNAME "$mnt_dev")
DISK="/dev/$disk_dev"
echo "Диск, на котором лежит /mnt: $DISK"

if [ "$UEFI_MODE" -eq 1 ]; then
    function grub() {
        echo "Установка GRUB для UEFI..."
        fast-chroot /mnt pacman -S grub os-prober efibootmgr --noconfirm
        fast-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB --removable --recheck
        fast-chroot /mnt bash -c 'sed -i "s/^GRUB_DISTRIBUTOR=.*/GRUB_DISTRIBUTOR=\"Quasar Linux\"/" /etc/default/grub || echo "GRUB_DISTRIBUTOR=\"Quasar Linux\"" >> /etc/default/grub'
        fast-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
        echo "GRUB установлен для UEFI"
    }
    
    function efistub() {
        echo "Установка EFISTUB..."
        fast-chroot /mnt pacman -S efibootmgr os-prober --noconfirm
        fast-chroot /mnt efibootmgr -b 0000 -B 2>/dev/null || true
        KERNEL=""
        INITRAMFS=""
        if fast-chroot /mnt test -f /boot/vmlinuz-linux; then
            KERNEL="linux"
        elif fast-chroot /mnt test -f /boot/vmlinuz-linux-zen; then
            KERNEL="linux-zen"
        elif fast-chroot /mnt test -f /boot/vmlinuz-linux-lts; then
            KERNEL="linux-lts"
        elsefast-chroot /mnt efibootmgr -c -d "$DISK" -p 1 -L "QuasarLinux" -l '\vmlinuz-linux.efi' -u "root=UUID=$ROOT_UUID rw initrd=\initramfs-linux.img"
            echo "Ошибка: не найдено ни одно ядро (linux, linux-zen, linux-lts)"
            exit 1
        fi
        cp "/mnt/boot/vmlinuz-$KERNEL" "/mnt/boot/efi/vmlinuz-$KERNEL.efi"
        cp "/mnt/boot/initramfs-$KERNEL.img" "/mnt/boot/efi/initramfs-$KERNEL.img"

        fast-chroot /mnt efibootmgr -c -d "$DISK" -p 1 -L "QuasarLinux" -l "\\vmlinuz-$KERNEL.efi"  -u "root=UUID=$ROOT_UUID rw initrd=\\initramfs-$KERNEL.img"
        echo "EFISTUB настроен"
    }
    
    function refind() {
        echo "Установка rEFInd..."
        fast-chroot /mnt pacman -S efibootmgr os-prober refind --noconfirm
        fast-chroot /mnt refind-install
        echo "rEFInd установлен"
    }

    boot=$(dialog --title "Выбор загрузчика UEFI" \
           --ok-label "Выбрать" \
           --no-cancel \
           --menu "Выберите загрузчик:" 15 40 4 \
           1 "GRUB" \
           2 "EFISTUB" \
           3 "rEFInd" 3>&1 1>&2 2>&3)
    
    case $boot in
        1) grub ;;
        2) efistub ;;
        3) refind ;;
    esac
else
    function grub() {
        echo "Установка GRUB для BIOS..."
        fast-chroot /mnt pacman -S grub os-prober --noconfirm
        fast-chroot /mnt grub-install --target=i386-pc --boot-directory=/boot --recheck "$DISK"
        fast-chroot /mnt bash -c 'sed -i "s/^GRUB_DISTRIBUTOR=.*/GRUB_DISTRIBUTOR=\"Quasar Linux\"/" /etc/default/grub || echo "GRUB_DISTRIBUTOR=\"Quasar Linux\"" >> /etc/default/grub'
        fast-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
        echo "GRUB установлен для BIOS"
    }
    
    function syslinux() { 
        echo "Установка Syslinux..."
        BOOT_PART=$(findmnt -n -o SOURCE /mnt/boot 2>/dev/null || findmnt -n -o SOURCE /mnt)
        BOOT_NUMBER=$(echo "$BOOT_PART" | sed 's/.*[^0-9]\([0-9]\+\)$/\1/')
        parted "$DISK" set "$BOOT_NUMBER" boot on
        
        fast-chroot /mnt pacman -S syslinux --noconfirm
        mkdir -p /mnt/boot/syslinux
        fast-chroot /mnt extlinux --install /boot/syslinux
        cp /mnt/usr/lib/syslinux/bios/*.c32 /mnt/boot/syslinux/
        fast-chroot /mnt dd if=/usr/lib/syslinux/bios/mbr.bin of="$DISK" bs=440 count=1 conv=notrunc
        
        cat > /mnt/boot/syslinux/syslinux.cfg << 'EOFD'
DEFAULT Quasarlinux
PROMPT 0
TIMEOUT 50

LABEL Quasarlinux
    KERNEL /vmlinuz-linux
    APPEND root=UUID=$ROOT_UUID rw
    INITRD /initramfs-linux.img
EOFD
        
        # Заменяем UUID в конфигурационном файле
        sed -i "s/\$ROOT_UUID/$ROOT_UUID/g" /mnt/boot/syslinux/syslinux.cfg
        echo "Syslinux установлен"
    }

    boot=$(dialog --title "Выбор загрузчика BIOS" \
           --ok-label "Выбрать" \
           --no-cancel \
           --menu "Выберите загрузчик:" 15 40 4 \
           1 "GRUB" \
           2 "Syslinux" 3>&1 1>&2 2>&3)
    
    case $boot in
        1) grub ;;
        2) syslinux ;;
    esac
fi

echo "Установка загрузчика завершена!"
