#!/bin/bash
set -euo pipefail
UEFI_MODE=0
export LUKS_MODE=0
[ -d /sys/firmware/efi ] && UEFI_MODE=1
clear

if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "Выберите диск"
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "Select disk"
fi
lsblk -d -o NAME,SIZE,MODEL,TYPE

if [ "${LENG_MODE:-}" = "ru" ]; then
    read -p "Введите имя диска (например, sda/nvme0n1): " DISK
elif [ "${LENG_MODE:-}" = "eu" ]; then
    read -p "Enter disk name (e.g., sda/nvme0n1): " DISK
fi
export DISK="/dev/$DISK"
if [ ! -e "$DISK" ]; then
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "Ошибка: диск $DISK не существует!"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "Error: disk $DISK does not exist!"
    fi
    exit 1
fi

# Функция авторазметки
auto_partition() {
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "=== АВТОРАЗМЕТКА ДИСКА ==="

        # Получаем размер диска в GB
        DISK_SIZE=$(fdisk -l "$DISK" | grep "Disk $DISK" | awk '{print int($3)}')
        echo "Размер диска: ${DISK_SIZE}GB"

        # Проверяем, достаточно ли места
        if [ "$DISK_SIZE" -lt 10 ]; then
            echo "Ошибка: Слишком маленький диск! Нужно минимум 10GB"
            exit 1
        fi

        # Очищаем таблицу разделов
        echo "Очистка таблицы разделов..."
        sgdisk -Z "$DISK" 2>/dev/null || dd if=/dev/zero of="$DISK" bs=1M count=100

        # Создаем новую таблицу разделов
        if [ $UEFI_MODE -eq 1 ]; then
            echo "Создание GPT таблицы разделов (UEFI)..."
            parted -s "$DISK" mklabel gpt
        else
            echo "Создание MBR таблицы разделов (BIOS)..."
            parted -s "$DISK" mklabel msdos
        fi

        # Создаем разделы согласно требованиям
        echo "Создание разделов..."
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "=== AUTOMATIC DISK PARTITIONING ==="

        # Получаем размер диска в GB
        DISK_SIZE=$(fdisk -l "$DISK" | grep "Disk $DISK" | awk '{print int($3)}')
        echo "Disk size: ${DISK_SIZE}GB"

        # Проверяем, достаточно ли места
        if [ "$DISK_SIZE" -lt 10 ]; then
            echo "Error: Disk is too small! Minimum 10GB required"
            exit 1
        fi

        # Очищаем таблицу разделов
        echo "Cleaning partition table..."
        sgdisk -Z "$DISK" 2>/dev/null || dd if=/dev/zero of="$DISK" bs=1M count=100

        # Создаем новую таблицу разделов
        if [ $UEFI_MODE -eq 1 ]; then
            echo "Creating GPT partition table (UEFI)..."
            parted -s "$DISK" mklabel gpt
        else
            echo "Creating MBR partition table (BIOS)..."
            parted -s "$DISK" mklabel msdos
        fi

        # Создаем разделы согласно требованиям
        echo "Creating partitions..."
    fi

    if [ $UEFI_MODE -eq 1 ]; then
        # UEFI разделы
        parted -s "$DISK" mkpart primary fat32 1MiB 513MiB
        parted -s "$DISK" set 1 esp on
        export BOOT_PART="${DISK}1"

        parted -s "$DISK" mkpart primary 513MiB 2GiB
        export RECOVERY_PART="${DISK}2"

        parted -s "$DISK" mkpart primary 2GiB 6GiB
        export SWAP_PART="${DISK}3"

        # Оставшееся место под корень
        parted -s "$DISK" mkpart primary 6GiB 100%
        export ROOT_PART="${DISK}4"
    else
        # BIOS разделы
        parted -s "$DISK" mkpart primary 1MiB 513MiB
        parted -s "$DISK" set 1 boot on
        export BOOT_PART="${DISK}1"

        parted -s "$DISK" mkpart primary 513MiB 2GiB
        export RECOVERY_PART="${DISK}2"

        parted -s "$DISK" mkpart primary 2GiB 6GiB
        export SWAP_PART="${DISK}3"

        # Оставшееся место под корень
        parted -s "$DISK" mkpart primary 6GiB 100%
        export ROOT_PART="${DISK}4"
    fi

    partprobe "$DISK"
    sleep 2

    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "=== СОЗДАННЫЕ РАЗДЕЛЫ ==="
        fdisk -l "$DISK" | grep "^/dev"
        echo "========================="
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "=== CREATED PARTITIONS ==="
        fdisk -l "$DISK" | grep "^/dev"
        echo "=========================="
    fi
}

# Функция форматирования разделов
format_partitions() {
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "=== ФОРМАТИРОВАНИЕ РАЗДЕЛОВ ==="

        # Форматируем EFI/Boot раздел
        if [ $UEFI_MODE -eq 1 ]; then
            echo "Форматирование EFI раздела (FAT32)..."
            mkfs.fat -F32 "$BOOT_PART"
        else
            echo "Форматирование Boot раздела (ext2)..."
            mkfs.ext2 -F "$BOOT_PART"
        fi

        # Форматируем корневой раздел (ext4)
        echo "Форматирование корневого раздела (ext4)..."
        mkfs.ext4 -F "$ROOT_PART"

        # Форматируем recovery раздел (ext2)
        echo "Форматирование recovery раздела (ext2)..."
        mkfs.ext2 -F "$RECOVERY_PART"

        # Создаем swap
        echo "Создание swap..."
        mkswap "$SWAP_PART"
        swapon "$SWAP_PART"

        echo "Форматирование завершено!"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "=== FORMATTING PARTITIONS ==="

        # Форматируем EFI/Boot раздел
        if [ $UEFI_MODE -eq 1 ]; then
            echo "Formatting EFI partition (FAT32)..."
            mkfs.fat -F32 "$BOOT_PART"
        else
            echo "Formatting Boot partition (ext2)..."
            mkfs.ext2 -F "$BOOT_PART"
        fi

        # Форматируем корневой раздел (ext4)
        echo "Formatting root partition (ext4)..."
        mkfs.ext4 -F "$ROOT_PART"

        # Форматируем recovery раздел (ext2)
        echo "Formatting recovery partition (ext2)..."
        mkfs.ext2 -F "$RECOVERY_PART"

        # Создаем swap
        echo "Creating swap..."
        mkswap "$SWAP_PART"
        swapon "$SWAP_PART"

        echo "Formatting completed!"
    fi
}

# Функция монтирования разделов
mount_partitions() {
    if [ "${LENG_MODE:-}" = "ru" ]; then
        echo "=== МОНТИРОВАНИЕ РАЗДЕЛОВ ==="

        # Монтируем корневой раздел
        mount "$ROOT_PART" /mnt

        # Создаем и монтируем boot/efi
        if [ $UEFI_MODE -eq 1 ]; then
            mkdir -p /mnt/boot/efi
            mount "$BOOT_PART" /mnt/boot/efi
        else
            mkdir -p /mnt/boot
            mount "$BOOT_PART" /mnt/boot
        fi

        # Создаем и монтируем recovery
        mkdir -p /mnt/recovery
        mount "$RECOVERY_PART" /mnt/recovery

        echo "Монтирование завершено!"
    elif [ "${LENG_MODE:-}" = "eu" ]; then
        echo "=== MOUNTING PARTITIONS ==="

        # Монтируем корневой раздел
        mount "$ROOT_PART" /mnt

        # Создаем и монтируем boot/efi
        if [ $UEFI_MODE -eq 1 ]; then
            mkdir -p /mnt/boot/efi
            mount "$BOOT_PART" /mnt/boot/efi
        else
            mkdir -p /mnt/boot
            mount "$BOOT_PART" /mnt/boot
        fi

        # Создаем и монтируем recovery
        mkdir -p /mnt/recovery
        mount "$RECOVERY_PART" /mnt/recovery

        echo "Mounting completed!"
    fi
}

# Основное меню выбора режима разметки
if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "=== ВЫБОР РЕЖИМА РАЗМЕТКИ ==="
    MODE=$(dialog --title "Quasar-install" --menu "Выберите режим разметки:" 15 60 3 \
    1 "Автоматическая разметка" \
    2 "Ручная разметка" \
    3 "Выход" 3>&1 1>&2 2>&3 3>&-)
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "=== SELECT PARTITIONING MODE ==="
    MODE=$(dialog --title "Quasar-install" --menu "Select partitioning mode:" 15 60 3 \
    1 "Automatic partitioning" \
    2 "Manual partitioning" \
    3 "Exit" 3>&1 1>&2 2>&3 3>&-)
fi

clear

case $MODE in
    1)
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Выбрана автоматическая разметка"
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Automatic partitioning selected"
        fi
        auto_partition
        format_partitions
        mount_partitions
        ;;
    2)
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Выбрана ручная разметка"
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Manual partitioning selected"
        fi
        # Оригинальный код для ручной разметки
        cfdisk "$DISK"

        if [ "${LENG_MODE:-}" = "ru" ]; then
            read -p "Введите раздел для ROOT (например, sda2): " ROOT_PART
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            read -p "Enter ROOT partition (e.g., sda2): " ROOT_PART
        fi
        ROOT_PART="/dev/$ROOT_PART"
        [ ! -e "$ROOT_PART" ] && echo "Ошибка: $ROOT_PART не существует!" && exit 1

        luks_enable_root() {
            if [ "${LENG_MODE:-}" = "ru" ]; then
                echo "╔══════════════════════════════════════╗"
                echo "║   Введите пароль для LUKS шифрования ║"
                echo "╚══════════════════════════════════════╝"
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                echo "╔══════════════════════════════════════╗"
                echo "║   Enter password for LUKS encryption ║"
                echo "╚══════════════════════════════════════╝"
            fi
            cryptsetup luksFormat --type luks2 --verify-passphrase "$ROOT_PART"

            # 2. Передаем пароль в cryptsetup
            cryptsetup luksOpen "$ROOT_PART" "QuasarRoot"
            export LUKS_MODE=1
        }

        if [ "${LENG_MODE:-}" = "ru" ]; then
            luks=$(dialog --title "Quasar-install" --menu "Зашифровать корневой раздел?  " 15 70 5 \
                1 "Да" \
                2 "Нет" 3>&1 1>&2 2>&3 3>&-)
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            luks=$(dialog --title "Quasar-install" --menu "Encrypt root partition?  " 15 70 5 \
                1 "Yes" \
                2 "No" 3>&1 1>&2 2>&3 3>&-)
        fi

        case $luks in
                1) luks_enable_root ;;
                2) true ;;
        esac

        format() {
            ext() {
                if [ $LUKS_MODE -eq 1 ]; then
                    mkfs.ext4 "/dev/mapper/QuasarRoot"
                else
                    mkfs.ext4 -F "$ROOT_PART"
                fi
            }

            btrfs() {
                if [ $LUKS_MODE -eq 1 ]; then
                     mkfs.btrfs -f "/dev/mapper/QuasarRoot"
                else
                     mkfs.btrfs -f "$ROOT_PART"
                fi
            }

            xfs() {
                if [ $LUKS_MODE -eq 1 ]; then
                    mkfs.xfs -f "/dev/mapper/QuasarRoot"
                else
                    mkfs.xfs -f  "$ROOT_PART"
                fi
            }

            if [ "${LENG_MODE:-}" = "ru" ]; then
                fs=$(dialog --title "Quasar-install" --menu "Выберите файловую систему: " 15 70 5 \
                1 "ext4" \
                2 "btrfs" \
                3 "xfs" 3>&1 1>&2 2>&3 3>&-)
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                fs=$(dialog --title "Quasar-install" --menu "Select filesystem: " 15 70 5 \
                1 "ext4" \
                2 "btrfs" \
                3 "xfs" 3>&1 1>&2 2>&3 3>&-)
            fi

            if [ $? -ne 0 ]; then
                if [ "${LENG_MODE:-}" = "ru" ]; then
                    echo "пропускаем"
                elif [ "${LENG_MODE:-}" = "eu" ]; then
                    echo "skipping"
                fi
                exit 0
            fi

            case $fs in
                1) ext ;;
                2) btrfs ;;
                3) xfs ;;
            esac
            clear
            if [ $LUKS_MODE -eq 1 ]; then
                mount /dev/mapper/QuasarRoot /mnt
            else
                mount "$ROOT_PART" /mnt
            fi
        }
        format

        lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT $DISK
        if [ $UEFI_MODE -eq 1 ]; then
            if [ "${LENG_MODE:-}" = "ru" ]; then
                read -p "Введите раздел для EFI (например, sda1): " BOOT_PART
                echo "Форматирование EFI раздела (FAT32)..."
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                read -p "Enter EFI partition (e.g., sda1): " BOOT_PART
                echo "Formatting EFI partition (FAT32)..."
            fi
            export  BOOT_PART="/dev/$BOOT_PART"
            mkdir -p /mnt/boot/efi
            mkfs.fat -F32 "$BOOT_PART"
            mount "$BOOT_PART" /mnt/boot/efi
        else
            if [ "${LENG_MODE:-}" = "ru" ]; then
                read -p "Введите раздел для BOOT (например, sda1): " BOOT_PART
                echo "Форматирование Boot раздела (ext2)..."
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                read -p "Enter BOOT partition (e.g., sda1): " BOOT_PART
                echo "Formatting Boot partition (ext2)..."
            fi
            BOOT_PART="/dev/$BOOT_PART"
            mkdir -p /mnt/boot
            mkfs.ext2 -F "$BOOT_PART"
            mount "$BOOT_PART" /mnt/boot
        fi

        [ ! -e "$BOOT_PART" ] && echo "Ошибка: $BOOT_PART не существует!" && exit 1

        # Дополнительные опции для ручного режима
        if [ "${LENG_MODE:-}" = "ru" ]; then
            read -p "Создать recovery раздел? (y/n): " CREATE_RECOVERY
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            read -p "Create recovery partition? (y/n): " CREATE_RECOVERY
        fi
        if [[ $CREATE_RECOVERY =~ ^[Yy]$ ]]; then
            if [ "${LENG_MODE:-}" = "ru" ]; then
                read -p "Введите раздел для RECOVERY (например, sda4): " RECOVERY_PART
                echo "Форматирование recovery раздела (ext2)..."
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                read -p "Enter RECOVERY partition (e.g., sda4): " RECOVERY_PART
                echo "Formatting recovery partition (ext2)..."
            fi
            RECOVERY_PART="/dev/$RECOVERY_PART"
            mkfs.ext2 -F "$RECOVERY_PART"
            mkdir -p /mnt/recovery
            mount "$RECOVERY_PART" /mnt/recovery
        fi

        if [ "${LENG_MODE:-}" = "ru" ]; then
            read -p "Создать swap раздел? (y/n): " CREATE_SWAP
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            read -p "Create swap partition? (y/n): " CREATE_SWAP
        fi
        if [[ $CREATE_SWAP =~ ^[Yy]$ ]]; then
            if [ "${LENG_MODE:-}" = "ru" ]; then
                read -p "Введите раздел для SWAP (например, sda3): " SWAP_PART
            elif [ "${LENG_MODE:-}" = "eu" ]; then
                read -p "Enter SWAP partition (e.g., sda3): " SWAP_PART
            fi
            SWAP_PART="/dev/$SWAP_PART"
            mkswap "$SWAP_PART"
            swapon "$SWAP_PART"
        fi
        ;;
    3)
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Выход..."
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Exiting..."
        fi
        exit 0
        ;;
    *)
        if [ "${LENG_MODE:-}" = "ru" ]; then
            echo "Неизвестный выбор"
        elif [ "${LENG_MODE:-}" = "eu" ]; then
            echo "Unknown choice"
        fi
        exit 1
        ;;
esac

# Показываем итоговую разметку
if [ "${LENG_MODE:-}" = "ru" ]; then
    echo "=== ИТОГОВАЯ РАЗМЕТКА ==="
    lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT "$DISK"
    echo "========================="

    echo "Разметка завершена успешно!"
elif [ "${LENG_MODE:-}" = "eu" ]; then
    echo "=== FINAL PARTITION LAYOUT ==="
    lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT "$DISK"
    echo "=============================="

    echo "Partitioning completed successfully!"
fi
