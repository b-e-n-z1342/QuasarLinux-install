#!/bin/bash
set -euo pipefail

# Обновление репозиториев
sudo pacman -Sy --noconfirm

packages=(
    "qt5"               "off"
    "qt6"               "on"
    "ffmpeg"            "off"
    "gamemode"          "off"
    "polkit"            "off"
    "x264"              "on"
    "x265"              "on"
    "openh264"          "on"
    "qemu-full"         "off"
    "qemu-base"         "off"
    "grub-customizer"   "off"
    "gtk2"              "off"
    "gtk3"              "off"
    "gtk4"              "off"
    "qbittorrent"       "off"
    "qbittorrent-openrc" "off"
    "vlc"               "off"
    "gwenview"          "off"
    "krita"             "off"
    "jdk-openjdk"       "off"
    "jre8-openjdk"      "off"
    "jre-openjdk"       "off"
    "openjdk-src"       "off"
    "kdeconnect"        "off"
    "virt-manager"      "off"
    "libvirt"           "off"
    "libvirt-openrc"    "off"
    "docker"            "off"
    "docker-openrc"     "off"
    "nmap"              "off"
    "wireshark-cli"     "off"
    "wireshark-qt"      "off"
    "cups"              "off"
    "cups-openrc"       "off"
    "lib32-libcups"     "off"
    "apcupsd"		"off"
    "apcupsd-openrc"	"off"
    "bluez-cups"	"off"
    "libcups"		"off"
    "libcupsfilters"	"off"
    "system-config-printer" "off"
    "bluedevil"		"off"
    "bluez"		"off"
    "bluez-libs"	"off"
    "bluez-qt5"		"off"
    "bluez-openrc"	"off"
    "gnome-bluetooth-3.0" "off"
    "bluez-utils"	"off"
)

# Проверка наличия dialog
if ! command -v dialog &> /dev/null; then
    echo "Установка dialog..."
    sudo pacman -S --noconfirm dialog
fi

# Формируем аргументы для dialog в правильном формате
dialog_args=()
for ((i = 0; i < ${#packages[@]}; i += 2)); do
    pkg="${packages[i]}"
    state="${packages[i+1]}"
    dialog_args+=("$pkg" "" "$state")
done

# Запуск диалога выбора
selected=$(dialog --stdout --checklist "Выберите нужные пакеты для установки:" 0 0 0 "${dialog_args[@]}")

dialog_exit_code=$?

case $dialog_exit_code in
    0)
        clear
        if [ -n "$selected" ]; then
            echo "Устанавливаем пакеты: $selected"
            # Убираем кавычки из вывода dialog
            install_list=$(echo "$selected" | tr -d '"')
            sudo pacman -S --noconfirm $install_list

            # Активация сервисов для выбранных пакетов
            echo "Активация сервисов..."

            # Добавление dbus в автозагрузку
            if rc-update add dbus default; then
                echo "dbus успешно добавлен в автозагрузку"
            else
                echo "пропускаем dbus..."
            fi

            # Активация сервисов для выбранных пакетов
            for pkg in $install_list; do
                case $pkg in
                    "qbittorrent-openrc")
                        if rc-update add qbittorrent default; then
                            echo "qbittorrent успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем qbittorrent..."
                        fi
                        ;;
                    "libvirt-openrc")
                        if rc-update add libvirtd default; then
                            echo "libvirtd успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем libvirtd..."
                        fi
                        ;;
                    "docker-openrc")
                        if rc-update add docker default; then
                            echo "docker успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем docker..."
                        fi
                        ;;
                    "cups-openrc")
                        if rc-update add cupsd default; then
                            echo "cupsd успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем cupsd..."
                        fi
                        ;;
                    "apcupsd-openrc")
                        if rc-update add apcupsd default; then
                            echo "apcupsd успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем apcupsd..."
                        fi
                        ;;
                    "bluez-openrc")
                        if rc-update add bluetooth default; then
                            echo "bluetooth успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем bluetooth..."
                        fi
                        ;;
                    "polkit")
                        if rc-update add polkit default; then
                            echo "polkit успешно добавлен в автозагрузку"
                        else
                            echo "пропускаем polkit..."
                        fi
                        ;;
                esac
            done

            echo "Установка завершена!"
        else
            echo "Не выбрано ни одного пакета."
        fi
        ;;
    1)
        clear
        echo "Выбор пакетов отменен."
        exit 0
        ;;
    255)
        clear
        echo "Диалог был прерван (ESC)."
        exit 1
        ;;
esac





clear
sudo mkdir -p /source
cd /source
git clone https://github.com/b-e-n-z1342/Systemd-rc.git
cd Systemd-rc && chmod +x install
sudo ./install
cd ..
git clone https://github.com/b-e-n-z1342/neofetch.git
cd neofetch
sudo make install
# Настройка локалей
#sudo sed -i 's/^#\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen
#sudo sed -i 's/^#\(ru_RU.UTF-8 UTF-8\)/\1/' /etc/locale.gen
#sudo locale-gen
#echo "LANG=ru_RU.UTF-8" | sudo tee /etc/locale.conf
cd /
# Запуск установки
#git clone https://github.com/quasarfoks/qbox.git
#cd qbox && chmod +x install_qbox
#sudo ./install_qbox
#cd
rm -rf /source
