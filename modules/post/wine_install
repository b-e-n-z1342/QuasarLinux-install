#!/bin/bash
set -euo pipefail
install_wine() {
    sudo pacman -S wine winetricks --noconfirm
}

install_wine_staging() {
    sudo pacman -S wine-staging winetricks --noconfirm
}

install_quasar_wine() {
    sudo pacman -S wine-staging winetricks gamemode --noconfirm
    wineboot --init
    sleep 2
    clear
    
    # Устанавливаем компоненты в фоновом режиме
    winetricks --force -q --unattended corefonts tahoma cjkfonts vcrun6 vcrun2003 vcrun2005 vcrun2008 vcrun2010 vcrun2012 vcrun2013 vcrun2015 vcrun2019 vcrun2022
    winetricks --force -q --unattended dotnet20 dotnet30 dotnet35 dotnet40 dotnet45 dotnet462 dotnet48 dotnetcoredesktop3 dotnetcoredesktop6
    winetricks --force -q --unattended d3dcompiler_43 d3dcompiler_47 d3dx9 d3dx10 d3dx11_43 directx9 directx10 directx11
    winetricks --force -q --unattended xact xinput quartz devenum wmp9 wmp10 wmp11 msxml3 msxml4 msxml6 gdiplus
    winetricks --force -q --unattended riched20 riched30 vb6run mfc40 mfc42 mfc70 mfc80 mfc90 mfc100 mfc110 mfc140
    winetricks --force -q --unattended ie8 flash silverlight physx openal dsound xna40 faudio dxvk vkd3d dgvoodoo2 win10
    
    sleep 5
    clear
    echo "Установка Quasar Wine завершена!"
}

install_wine_ge() {
    mkdir -p ~/.apps
    cd ~/.apps || exit 1
    
    wget -P /tmp https://github.com/GloriousEggroll/wine-ge-custom/releases/download/GE-Proton8-26/wine-lutris-GE-Proton8-26-x86_64.tar.xz
    tar -xf /tmp/wine-lutris-GE-Proton8-26-x86_64.tar.xz
    mv lutris-GE-Proton8-26-x86_64 wine-ge
    
    # Добавляем в PATH для текущей сессии
    export PATH="$HOME/.apps/wine-ge/bin:$PATH"
    export XDG_DATA_DIRS="$HOME/.apps/wine-ge/share:$XDG_DATA_DIRS"
    
    # Добавляем в .bashrc для будущих сессий
    echo 'export PATH="$HOME/.apps/wine-ge/bin:$PATH"' >> ~/.bashrc
    echo 'export XDG_DATA_DIRS="$HOME/.apps/wine-ge/share:$XDG_DATA_DIRS"' >> ~/.bashrc
    
    wineboot --init
    echo "Wine-GE установлен и настроен!"
}

install_proton_ge() {
    mkdir -p ~/.apps
    cd ~/.apps || exit 1
    
    wget -P /tmp https://github.com/GloriousEggroll/proton-ge-custom/releases/download/GE-Proton10-13/GE-Proton10-13.tar.gz
    tar -xf /tmp/GE-Proton10-13.tar.gz
    
    # Создаем символические ссылки
    sudo mkdir -p /usr/local/bin /usr/local/share
    sudo ln -sf ~/.apps/GE-Proton10-13/files/bin/* /usr/local/bin/
    sudo ln -sf ~/.apps/GE-Proton10-13/files/share/* /usr/local/share/
    
    echo "Proton-GE установлен!"
}

install_portproton() {
    yay -S portproton --noconfirm
}

choice=$(dialog --title "Меню" --menu "Выберите нужный wine: " 15 70 6 \
    1 "Wine" \
    2 "Wine-staging" \
    3 "Wine-staging с DXVK/VKD3D" \
    4 "Wine-ge" \
    5 "Proton-ge" \
    6 "PortProton" \
    3>&1 1>&2 2>&3 3>&-)

case $? in
    0)
        case $choice in
            1) install_wine ;;
            2) install_wine_staging ;;
            3) install_quasar_wine ;;
            4) install_wine_ge ;;
            5) install_proton_ge ;;
            6) install_portproton ;;
            *) echo "Неверный выбор" ;;
        esac
        ;;
    *)
        echo "Установка Wine отменена."
        ;;
esac
